# Trading Fitness - Root mise configuration
# SSoT for runtime versions and shared environment
# Package-specific tasks are in packages/*/mise.toml
#
# Architecture:
#   Root: [tools], [env], orchestration, cross-package delegation
#   packages/ith-python/mise.toml: Python analysis, forensic, features, data
#   packages/metrics-rust/mise.toml: Rust build, test, bench
#   packages/shared-types/mise.toml: Type generation

[env]
GH_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/gh-token-terrylica') | trim }}"
GITHUB_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/gh-token-terrylica') | trim }}"
LOG_DIR = "{{config_root}}/logs"
ENV = "dev"
UV_PYTHON = "python3.13"
TRADING_FITNESS_ROOT = "{{config_root}}"

[tools]
python = "3.13"
rust = "stable"
node = "22"
bun = "latest"
uv = "latest"
"cargo:ast-grep" = "latest"

# =============================================================================
# Monorepo-Wide Tasks (Orchestration)
# =============================================================================

[tasks.lint]
description = "Lint all packages"
run = "cd packages/ith-python && uv run ruff check --fix"

[tasks.test]
description = "Test all packages"
run = """
cd packages/ith-python && uv run pytest
cargo nextest run -p trading-fitness-metrics
"""

[tasks.affected]
description = "List affected packages"
run = "bash scripts/affected.sh list"

[tasks."test:affected"]
run = "bash scripts/affected.sh test"

# =============================================================================
# ITH Analysis - Orchestration
# =============================================================================

[tasks.analyze]
description = "Incremental ITH analysis"
depends = ["analyze:bear"]
run = "open artifacts/bull_results.html artifacts/bear_results.html"

[tasks."analyze:fresh"]
description = "Fresh ITH analysis - clears artifacts first"
depends = ["analyze:fresh:bear"]
run = "open artifacts/bull_results.html artifacts/bear_results.html"

[tasks."analyze:bull"]
description = "Incremental Bull ITH"
run = "cd packages/ith-python && mise run run:bull"

[tasks."analyze:bear"]
description = "Incremental Bear ITH"
depends = ["analyze:bull"]
run = "cd packages/ith-python && mise run run:bear"

[tasks."analyze:fresh:bull"]
description = "Fresh Bull ITH - clears artifacts first"
run = "cd packages/ith-python && mise run fresh:bull"

[tasks."analyze:fresh:bear"]
description = "Fresh Bear ITH - clears artifacts first"
depends = ["analyze:fresh:bull"]
run = "cd packages/ith-python && mise run fresh:bear"

# =============================================================================
# Type Generation - Delegates to shared-types
# =============================================================================

[tasks.generate-types]
description = "Generate types from JSON Schema"
run = "cd packages/shared-types && mise run generate"

[tasks."generate-types:python"]
description = "Generate Python types"
run = "cd packages/shared-types && mise run generate:python"

[tasks."generate-types:typescript"]
description = "Generate TypeScript types"
run = "cd packages/shared-types && mise run generate:typescript"

[tasks."generate-types:rust"]
description = "Generate Rust types"
run = "cd packages/shared-types && mise run generate:rust"

# =============================================================================
# metrics-rust - Delegates to package
# =============================================================================

[tasks."build:metrics-rust"]
description = "Build metrics-rust Rust library"
run = "cd packages/metrics-rust && mise run build"

[tasks."test:metrics-rust"]
description = "Test metrics-rust"
run = "cd packages/metrics-rust && mise run test"

[tasks."develop:metrics-rust"]
description = "Build Python bindings and install into ith-python venv"
run = "cd packages/metrics-rust && mise run develop"

[tasks."cross-validate:ith"]
description = "Cross-validate Numba vs Rust ITH"
depends = ["develop:metrics-rust"]
run = "cd packages/ith-python && mise run cross-validate:ith"

# =============================================================================
# Data Layer - Delegates to ith-python
# =============================================================================

[tasks."preflight:warmup"]
description = "Validate data sufficiency after warmup"
run = "cd packages/ith-python && mise run preflight:warmup"

[tasks."preflight:data-config"]
description = "Load and validate forensic configuration"
run = "cd packages/ith-python && mise run preflight:data-config"

[tasks."preflight:rangebar-cache"]
description = "Check range bar cache availability"
run = "cd packages/ith-python && mise run preflight:rangebar-cache"

[tasks."data:precompute"]
description = "Precompute missing range bar data (incremental)"
run = "cd packages/ith-python && mise run data:precompute-incremental"

[tasks."data:validate"]
description = "Validate range bar continuity"
run = "cd packages/ith-python && mise run data:validate-continuity"

[tasks."data:precompute-historical"]
description = "Precompute 3 years of range bar data (sequential)"
run = "cd packages/ith-python && mise run data:precompute-historical"

[tasks."data:precompute-parallel"]
description = "Precompute 3 years of range bar data (parallel, 8 workers)"
run = "cd packages/ith-python && mise run data:precompute-parallel"

[tasks."data:precompute-status"]
description = "Check precompute job status"
run = "cd packages/ith-python && mise run data:precompute-status"

[tasks."data:precompute-tail"]
description = "Follow precompute log"
run = "cd packages/ith-python && mise run data:precompute-tail"

[tasks."data:precompute-stop"]
description = "Stop precompute job"
run = "cd packages/ith-python && mise run data:precompute-stop"

[tasks."data:cache-status"]
description = "Show ClickHouse cache status"
run = "cd packages/ith-python && mise run data:cache-status"

# =============================================================================
# Feature Computation - Delegates to ith-python
# =============================================================================

[tasks."features:compute"]
description = "Compute ITH features (Layer 1)"
run = "cd packages/ith-python && mise run features:compute"

[tasks."upgrade:features"]
description = "Rebuild features only"
run = "mise run features:compute"

# =============================================================================
# ClickHouse Management
# =============================================================================

[tasks."preflight:clickhouse"]
description = "Ensure ClickHouse is running"
run = """
if pgrep -f "clickhouse server" > /dev/null; then
    echo "ClickHouse already running"
    exit 0
fi

echo "Starting ClickHouse server..."
CLICKHOUSE_BIN=$(ls ~/.local/share/mise/installs/clickhouse/*/bin/clickhouse 2>/dev/null | head -1)
if [ -z "$CLICKHOUSE_BIN" ]; then
    echo "ERROR: ClickHouse not installed. Run: mise install clickhouse"
    exit 1
fi

CONFIG_FILE="$HOME/.clickhouse-local/config.xml"
if [ ! -f "$CONFIG_FILE" ]; then
    echo "ERROR: ClickHouse config not found at $CONFIG_FILE"
    exit 1
fi

cd ~/.clickhouse-local
nohup "$CLICKHOUSE_BIN" server --config-file="$CONFIG_FILE" > server.log 2>&1 &

echo "Waiting for ClickHouse to start..."
for i in {1..30}; do
    if "$CLICKHOUSE_BIN" client --query "SELECT 1" > /dev/null 2>&1; then
        echo "ClickHouse started successfully"
        exit 0
    fi
    sleep 1
done

echo "ERROR: ClickHouse failed to start"
exit 1
"""

[tasks."forensic:start-clickhouse"]
description = "Start ClickHouse server"
run = "mise run preflight:clickhouse"

[tasks."forensic:stop-clickhouse"]
description = "Stop ClickHouse server"
run = """
if pgrep -f "clickhouse server" > /dev/null; then
    echo "Stopping ClickHouse server..."
    pkill -f "clickhouse server"
    echo "ClickHouse stopped"
else
    echo "ClickHouse not running"
fi
"""

# =============================================================================
# Symmetric Dogfooding - Cross-Repo Validation
# ADR: docs/adr/2026-01-27-symmetric-dogfooding-rangebar.md
# =============================================================================

[tasks."validate:symmetric"]
description = "Validate ITH metrics against rangebar-py (symmetric dogfooding)"
run = """
echo "═══════════════════════════════════════════════════════════"
echo "  Symmetric Dogfooding: trading-fitness ↔ rangebar-py"
echo "═══════════════════════════════════════════════════════════"

# Step 1: Check rangebar version pin
echo ""
echo "→ Step 1: Checking rangebar-py version pin..."
RANGEBAR_PIN=$(grep 'rangebar = ' packages/ith-python/pyproject.toml | grep -o 'tag = "[^"]*"' || echo "")
if [ -z "$RANGEBAR_PIN" ]; then
    echo "  ✗ FAIL: rangebar-py not pinned to tag (using branch)"
    echo "  Fix: Update pyproject.toml to use tag instead of branch"
    exit 1
fi
echo "  ✓ Pinned: $RANGEBAR_PIN"

# Step 2: Sync dependencies with validation group
echo ""
echo "→ Step 2: Syncing dependencies (validation group)..."
cd packages/ith-python
uv sync --group dev
echo "  ✓ Dependencies synced"

# Step 3: Run integration tests
echo ""
echo "→ Step 3: Running integration tests..."
if [ -d "tests/integration" ] && [ -n "$(ls tests/integration/test_*.py 2>/dev/null)" ]; then
    uv run pytest tests/integration/ -v
    echo "  ✓ Integration tests passed"
else
    echo "  ⚠ No integration tests found (tests/integration/test_*.py)"
    echo "  Consider adding tests that validate ITH metrics on real range bars"
fi

# Step 4: Quick smoke test - can we import and use rangebar?
echo ""
echo "→ Step 4: Smoke test - rangebar import..."
uv run python -c '
import rangebar
print("  ✓ rangebar imported successfully")
ver = getattr(rangebar, "__version__", "unknown")
print(f"    Version: {ver}")
print("    Functions: get_range_bars, RangeBarCache available")
'

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ✓ Symmetric dogfooding validation complete"
echo "═══════════════════════════════════════════════════════════"
"""

[tasks."validate:pre-release"]
description = "Full pre-release validation (includes symmetric dogfooding)"
depends = ["test", "validate:symmetric"]
run = """
echo ""
echo "Pre-release validation complete:"
echo "  ✓ All tests passed"
echo "  ✓ Symmetric dogfooding validated"
echo "  → Ready to release"
"""

# =============================================================================
# Full Pipelines (DAG Orchestration)
# =============================================================================

[tasks."forensic:pipeline"]
description = "Full pipeline: compute -> views -> analyze"
run = """
mise run features:compute
cd packages/ith-python && mise run views:all && mise run analysis:all

echo ""
echo "Multi-View Feature Pipeline Complete"
echo "  SSoT: artifacts/ssot/features_long.parquet"
echo "  Views: artifacts/views/"
echo "  Analysis: artifacts/analysis/"
"""

[tasks."forensic:full-pipeline"]
description = "Complete pipeline with data preflight (DAG)"
run = """
mise run preflight:clickhouse
mise run preflight:data-config
mise run preflight:rangebar-cache
mise run data:precompute
mise run data:validate
mise run preflight:warmup
mise run features:compute
cd packages/ith-python && mise run views:all && mise run analysis:all

echo ""
echo "Full Forensic Pipeline Complete"
echo "  Config: config/forensic.toml"
echo "  SSoT: artifacts/ssot/features_long.parquet"
echo "  Views: artifacts/views/"
echo "  Analysis: artifacts/analysis/"
"""
